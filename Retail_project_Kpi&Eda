--EDA FOR TRANSACTION NEW TABLE 
SELECT * FROM TRANSACTION_NEW LIMIT 1;

ALTER TABLE TRANSACTION_NEW 
DROP COLUMN WEEK_NO ; -- REMOVED WEEK_NO COLUMN 

SELECT COUNT(BASKET_ID) FROM TRANSACTION_NEW; -- 450416 TOTAL BASKET ID 

SELECT COUNT(DISTINCT BASKET_ID) FROM TRANSACTION_NEW; -- 50478 UNIQUE ID 

SELECT COUNT (DISTINCT HOUSEHOLD_KEY ) FROM TRANSACTION_NEW ;  --2494 UNIQUE 

SELECT BASKET_ID , SUM(SALES_VALUE) , SUM(COUPON_DISC) , SUM(COUPON_MATCH_DISC)
FROM TRANSACTION_NEW 
GROUP BY 1 
ORDER BY 2 DESC; 

SELECT COUNT( DISTINCT BASKET_ID) FROM TRANSACTION_NEW 
WHERE COUPON_DISC <> 0;  -- ONLY 2587 COUPON ARE USED  

SELECT ROUND(SUM(SALES_VALUE)/COUNT(DISTINCT BASKET_ID)) FROM TRANSACTION_NEW ;
--THE AVERAGE BASKET SALES VALUE IS $26.93 OR $27

SELECT * FROM TRANSACTION_NEW
ORDER BY RETAIL_DISC ;


SELECT ROUND(SUM(SALES_VALUE)/COUNT(DISTINCT BASKET_ID)) 
FROM TRANSACTION_NEW
WHERE COUPON_DISC != 0 ;


SELECT ROUND(SUM(SALES_VALUE)/COUNT(DISTINCT BASKET_ID)) 
FROM TRANSACTION_NEW
WHERE COUPON_DISC = 0 ;

SELECT  COUNT(DISTINCT BASKET_ID) FROM TRANSACTION_NEW 
WHERE COUPON_DISC = 0 ;--50403  

SELECT  COUNT(DISTINCT BASKET_ID) FROM TRANSACTION_NEW 
WHERE COUPON_DISC <> 0 ;--2587

SELECT AVG(SALES_VALUE) FROM TRANSACTION_NEW 
WHERE COUPON_DISC = 0 ;  --$3
SELECT AVG(SALES_VALUE) FROM TRANSACTION_NEW 
WHERE COUPON_DISC <> 0 ; --$4

SELECT * FROM PRODUCT_RAW P
FULL OUTER JOIN TRANSACTION_NEW T 
ON P.PRODUCT_ID = T.PRODUCT_ID ;

SELECT DISTINCT COMMODITY_DESC , COUNT (COMMODITY_DESC)FROM PRODUCT_RAW
GROUP BY 1 
ORDER BY 2 DESC;

SELECT HOUSEHOLD_KEY , SUM(SALES_VALUE) , SUM(COUPON_DISC) , SUM(COUPON_MATCH_DISC) FROM TRANSACTION_NEW
GROUP BY 1 
ORDER BY 3 , 2 DESC;

SELECT DISTINCT MONTH(DATE) FROM TRANSACTION_NEW;

--KPI 

--DEMOGRAPHIC KPI 
--Q1
SELECT COUNT(DISTINCT HOUSEHOLD_KEY) AS NO_OF_HOUSEHOLDS FROM DEMOGRAPHIC ;
--2500 UNIQUE HOUSEHOLDS

--Q2
SELECT HH_COMP_DESC , COUNT(HH_COMP_DESC) FROM DEMOGRAPHIC 
GROUP BY 1 
ORDER BY 2 DESC ;
--THERE ARE 800 HOUSEHOLDS HAVING ONLY 2 ADULTS WITH NO KIDS .
--584 WITH 2 ADULT KIDS  . 446 Single Female ,Single Male ARE 292 , UNKNOWN ARE 229 AND ONLY 1 ADULT KIDS
--ARE 149  

--Q3
SELECT AGE_DESC , COUNT(AGE_DESC) AS NO_OF_PEOPLE , 
ROUND(COUNT(AGE_DESC)/2500*100,2) AS PERCENTAGE 
FROM DEMOGRAPHIC 
GROUP BY 1 
ORDER BY 2 DESC ;

--Q4
SELECT MARITAL_STATUS_CODE , COUNT(MARITAL_STATUS_CODE) AS MARITAL_STATUS , 
ROUND(COUNT(MARITAL_STATUS_CODE)/2500 * 100,2 )AS PERCENTAGE_DISTRIBUTION 
FROM DEMOGRAPHIC 
GROUP BY 1 
ORDER BY 2 DESC ;

--Q5
SELECT INCOME_DESC  , COUNT(INCOME_DESC) AS NO_OF_PEOPLE , 
ROUND(COUNT(INCOME_DESC)/2500 * 100 , 2) AS PERCENTAGE FROM DEMOGRAPHIC 
GROUP BY 1 
ORDER BY 2 DESC ;

--Q6
SELECT HOMEOWNER_DESC , ROUND(COUNT(HOMEOWNER_DESC)/2500*100,2) AS PERCENTAGE  FROM DEMOGRAPHIC
GROUP BY 1 
ORDER BY 2 DESC ;

SELECT HOMEOWNER_DESC , COUNT( HOMEOWNER_DESC ) FROM DEMOGRAPHIC 
GROUP BY 1 
ORDER BY 2 DESC;

SELECT * FROM DEMOGRAPHIC LIMIT 1 ;


--KPI FOR CAMPAIGN AND CAMPAIGN DESC TABLE 
--Q1 
SELECT COUNT(DISTINCT CAMPAIGN) AS TOTAL_CAMPAIGNS 
FROM CAMPAIGN_RAW ;  -- TOTAL 30 CAMPAIGNS WERE LAUNCHED BETWEEN 12TH AUGUST 2020 AND 20TH DECEMBER 2021 

--Q2
SELECT CAMPAIGN, DATEDIFF(D,START_DATE,END_DATE) AS CAMPAIGNDURATION 
FROM CAMPAIGN_DESC_NEW1 
ORDER BY 2 DESC ;
-- CAMPAIGNNO 15 LASTED FOR 161 DAYS, CAMPAIGN 20 LASTED FOR 70 DAYS AND 14 LASTED FOR 65 DAYS 

--Q3
SELECT CAMPAIGN , COUNT(DISTINCT HOUSEHOLD_KEY) FROM CAMPAIGN_RAW 
GROUP BY 1 
ORDER BY 2 DESC ;-- CAMPAIGN 18 HAS THE MAXIMUM REACH OF 1133 HOUSES FOLLOWED BY CAMPAIGN13 WITH 1077HPUSEHOLDS AND CAMPAIGN 8 WITH 1076 HOUSEHOLDS 

CREATE TABLE CAMPAIGN_DESC_NEW1  AS SELECT DISTINCT * FROM CAMPAIGN_DESC_NEW;

SELECT * FROM CAMPAIGN_DESC_NEW1
ORDER BY END_DATE DESC;
SELECT * FROM CAMPAIGN_DESC_NEW1
ORDER BY START_DATE;

SELECT * FROM CAMPAIGN_RAW LIMIT 1 ;
SELECT * FROM CAMPAIGN_DESC_NEW1; 
SELECT DISTINCT DESCRIPTION FROM CAMPAIGN_RAW ;

--KPI FOR COUPON TABLE 
--Q1
SELECT COUNT (DISTINCT COUPON_UPC) FROM COUPON_RAW; --1135

SELECT COUNT(DISTINCT COUPON_UPC ) FROM COUPON_REDEMPT_NEW;--556 

SELECT ROUND (COUNT (DISTINCT CR.COUPON_UPC) / COUNT (DISTINCT C.COUPON_UPC)*100,2)
AS PERCENTAGE_COUPON_REDEEMNED 
FROM COUPON_RAW C LEFT OUTER JOIN COUPON_REDEMPT_NEW CR 
ON C.COUPON_UPC = CR.COUPON_UPC; -- 48.99% OF COUPONS WERE REDEEMEND .


--Q2
SELECT C.CAMPAIGN ,COUNT(DISTINCT CR.COUPON_UPC) AS COUPON_REDEEMED FROM COUPON_REDEMPT_NEW CR
INNER JOIN COUPON_RAW C 
ON C.COUPON_UPC  = CR.COUPON_UPC
GROUP BY 1 
ORDER BY 2 DESC ;--136 COUPON REDEEMED FOR CAMPAIGN 13 , 124 FOR CAMPAIGN 18 
--AND CAMPAIGN 8 HAS 115  COUPONS REEDEMED .
--1 , 15 , 24 AND 6 CAMPAIGNS HAD THE LEAST COUPONS REEDEMED 


SELECT * FROM COUPON_RAW LIMIT 1 ;
SELECT * FROM COUPON_REDEMPT_NEW LIMIT 1 ;

--PRODUCT KPI

--Q1
SELECT  P.COMMODITY_DESC , SUM(T.SALES_VALUE) FROM PRODUCT_RAW P
INNER JOIN TRANSACTION_NEW T 
ON P.PRODUCT_ID = T.PRODUCT_ID 
GROUP BY 1
ORDER BY 2 DESC ; 
-- TOP 3 SELLING PROUCTS ARE COUPON/MISC ITEMS  WITH SALES OF   $93573.7,
--SOFT DRINKS WITH SALES OF $61407.76 , BEEF  WITH SALES OF $57303.19

--Q2
SELECT MANUFACTURER , COUNT (DISTINCT PRODUCT_ID) FROM PRODUCT_RAW 
GROUP BY 1 
HAVING COUNT (DISTINCT PRODUCT_ID) > 1000
ORDER BY 2 DESC ;
-- MANUFACTURER 69 SELLS HIGHEST 12,676 PRODUCTS , MANUFACTURER 2 SELLS 1411 
-- MANUFACTURER 5423 SELLS 1371 . 

--Q3DEPARTMENT WISE SALES :
SELECT P.DEPARTMENT , ROUND (SUM(T.SALES_VALUE)) FROM PRODUCT_RAW P 
INNER JOIN TRANSACTION_NEW T 
ON P.PRODUCT_ID = T.PRODUCT_ID 
GROUP BY 1 
ORDER BY 2 DESC ;
--GROCERY DEPARTMENT HAS THE HIGHEST SALES WITH $694,540 , DRUG GM DEPARTMENT  HAS SALES OF $179,496
--MEAT DEPARTMENT HAS SALES OF $97,348


--Q4 BRAND WISE SALES 
SELECT P.BRAND , ROUND (SUM(T.SALES_VALUE)) AS TOTAL_SALES FROM PRODUCT_RAW P 
INNER JOIN TRANSACTION_NEW T 
ON P.PRODUCT_ID = T.PRODUCT_ID 
GROUP BY 1 
ORDER BY 2 DESC ;
-- NATIONAL HAS SALES OF $1000456 AND PRIVATE HAS SALES OF $359096

-- TRANSACTIONS KPI 
--Q1 TOTAL SALES VALUE 
SELECT SUM(SALES_VALUE) AS TOTAL_SALES FROM TRANSACTION_NEW ;
-- TOTAL OVER ALL SALES ARE $ 1,359,551.73

--Q2
SELECT AVG(SALES_VALUE) FROM TRANSACTION_NEW ;
--$3.01 IS THE AVG TRANSACTION VALUES 

--Q3
SELECT P.DEPARTMENT , SUM (T.QUANTITY) FROM TRANSACTION_NEW T
INNER JOIN PRODUCT_RAW P 
ON P.PRODUCT_ID = T.PRODUCT_ID
GROUP BY 1
ORDER BY 2 DESC ;
-- KIOK GAS HAS THE MAXIMUM QUANTITY SOLD WITH 33104827 , MISC SALES TRAN HAS  5287965
-- GROCERY IS 3RD HIGHEST WITH 372201 OF QUANTITY BEING SOLD .
--CNTRL/STORE SUP IS LEAST WITH 0 QUANTITY BEING SOLD .

--Q4
SELECT PRODUCT_ID , SUM(SALES_VALUE) , SUM(RETAIL_DISC) , SUM(COUPON_DISC) 
, SUM(COUPON_MATCH_DISC) FROM TRANSACTION_NEW 
GROUP BY 1 
ORDER BY 3 ;
-- THE SALES VALUE INCREASES WHEN THE RETAIL AND COUPON DISCOUNTS ARE GIVEN TO THE CUSTOMERS 

SELECT * FROM PRODUCT_RAW LIMIT 10;
SELECT * FROM TRANSACTIOCOUPON_DISCN_NEW LIMIT 10 ;

-- CREATING MASTER TABLE 
CREATE OR REPLACE TABLE MASTER_RETAIL_ANALSYS AS SELECT T.HOUSEHOLD_KEY,D.AGE_DESC,D.MARITAL_STATUS_CODE,D.INCOME_DESC,AVG(T.SALES_VALUE)AS AVG_AMOUNT,
AVG(T.RETAIL_DISC)AS AVG_RETAIL_DIS,AVG(T.COUPON_DISC)AS AVG_COUPON_DISC,AVG(T.COUPON_MATCH_DISC)AS AVG_COUP_MATCH_DISC
FROM TRANSACTION_NEW T
LEFT OUTER JOIN DEMOGRAPHIC D ON T.HOUSEHOLD_KEY =D.HOUSEHOLD_KEY
GROUP BY 1,2,3,4
ORDER BY 1;

SELECT * FROM MASTER_RETAIL_ANALSYS ;

ALTER TABLE DEMOGRAPHIC 
ADD COLUMN MARITAL_STATUS VARCHAR(50);

UPDATE DEMOGRAPHIC 
SET  MARITAL_STATUS = 'Married'
WHERE MARITAL_STATUS_CODE = 'A' ;

UPDATE DEMOGRAPHIC 
SET MARITAL_STATUS = 'Unmarried'
WHERE MARITAL_STATUS_CODE = 'U' ; 

UPDATE DEMOGRAPHIC 
SET  MARITAL_STATUS = 'Divorced'
WHERE MARITAL_STATUS_CODE = 'B';        

SELECT * FROM DEMOGRAPHIC LIMIT 1;

SELECT DISTINCT HH_COMP_DESC FROM DEMOGRAPHIC ;

SELECT DISTINCT KID_CATEGORY_DESC FROM DEMOGRAPHIC ;

ALTER TABLE CAMPAIGN_DESC_NEW1 
DROP COLUMN CAMPAIGN_DURATION;

SELECT * FROM CAMPAIGN_DESC_NEW1 ;

SELECT DATEDIFF(D,START_DATE,END_DATE) AS DURATION_DIFFERENCE FROM CAMPAIGN_DESC_NEW;

ALTER TABLE CAMPAIGN_DESC_NEW
ADD COLUMN CAM_DURATION INT ;

UPDATE CAMPAIGN_DESC_NEW
SET CAM_DURATION = DATEDIFF(DAY,START_DATE,END_DATE)
WHERE CAMPAIGN = 24 ;

UPDATE CAMPAIGN_DESC_NEW
SET CAM_DURATION = DATEDIFF(DAY,START_DATE,END_DATE)
WHERE CAMPAIGN BETWEEN 1 AND 30 ;

SHOW TABLES;

SELECT * FROM CAMPAIGN_DESC_NEW1;
COMMIT ;

CREATE TABLE CAMPAIGN_DESCRIPTION AS SELECT * FROM CAMPAIGN_DESC_NEW1 ;


SELECT C.DESCRIPTION , SUM(T.SALES_VALUE) FROM CAMPAIGN_RAW C
INNER JOIN TRANSACTION_NEW T 
ON T.HOUSEHOLD_KEY = C.HOUSEHOLD_KEY 
GROUP BY 1 
ORDER BY 2 DESC;

 
SELECT DISTINCT MARITAL_STATUS  FROM DEMOGRAPHIC ;

CREATE OR REPLACE VIEW  PRODUCT_CAMPAIGN AS 
SELECT CR.CAMPAIGN , COUNT(P.PRODUCT_ID) AS PRODUCT_COUNT  FROM PRODUCT_RAW P 
INNER JOIN TRANSACTION_NEW T 
ON P.PRODUCT_ID = T.PRODUCT_ID 
INNER JOIN CAMPAIGN_RAW CR 
ON T.HOUSEHOLD_KEY = CR.HOUSEHOLD_KEY
GROUP BY 1;

SELECT * FROM PRODUCT_CAMPAIGN 
ORDER BY PRODUCT_COUNT DESC;



SELECT COUNT (DISTINCT COMMODITY_DESC) FROM PRODUCT_RAW ;
SELECT MANUFACTURER , COUNT(SUB_COMMODITY_DESC) FROM PRODUCT_RAW 
GROUP BY 1 
ORDER BY 2 DESC;

CREATE OR REPLACE VIEW  MANU_SALES AS 
SELECT P.MANUFACTURER , SUM(T.SALES_VALUE) AS TOTAL_SALES  FROM PRODUCT_RAW P  
INNER  JOIN TRANSACTION_NEW T 
ON P.PRODUCT_ID = T.PRODUCT_ID 
GROUP BY 1 
ORDER BY 2 DESC ; 

CREATE OR REPLACE VIEW  MANU_SALES2 AS 
SELECT P.MANUFACTURER , SUM(T.SALES_VALUE) AS TOTAL_SALES  FROM PRODUCT_RAW P  
LEFT OUTER JOIN TRANSACTION_NEW T 
ON P.PRODUCT_ID = T.PRODUCT_ID 
GROUP BY 1 
ORDER BY 2 DESC ;

SELECT * FROM PRODUCT_RAW ;
SELECT * FROM TRANSACTION_NEW T ;

CREATE VIEW HOUSE_PROD AS 
SELECT D.HOUSEHOLD_KEY , COUNT (P.PRODUCT_ID) AS PRODUCT_COUNT  FROM DEMOGRAPHIC D 
LEFT OUTER JOIN TRANSACTION_NEW T 
ON D.HOUSEHOLD_KEY = T.HOUSEHOLD_KEY 
LEFT OUTER JOIN PRODUCT_RAW P
ON P.PRODUCT_ID = T.PRODUCT_ID 
GROUP BY 1 
ORDER BY 2 DESC ;

SELECT * FROM HOUSE_PROD ;

CREATE VIEW COUPON_REDEMPTION AS 
SELECT C.CAMPAIGN , COUNT(DISTINCT C.COUPON_UPC) AS COUPON_GIVEN, COUNT(DISTINCT  CR.COUPON_UPC) AS COUPON_REDEEMED FROM COUPON_RAW C
LEFT OUTER JOIN COUPON_REDEMPT_NEW CR 
ON CR.CAMPAIGN = C.CAMPAIGN
GROUP BY 1 
ORDER BY 3 DESC ;

CREATE VIEW DEP_COUP As 
SELECT P.DEPARTMENT , COUNT(DISTINCT C.COUPON_UPC) AS COUPON_GIVEN FROM PRODUCT_RAW P 
INNER JOIN COUPON_RAW C 
ON P.PRODUCT_ID = C.PRODUCT_ID 
GROUP BY 1 
ORDER BY 2 DESC ;

SELECT * FROM DEP_COUP ;

CREATE VIEW INCOME_COUP AS 
SELECT D.INCOME_DESC , COUNT(DISTINCT C.COUPON_UPC) AS COUPON_REDEEMED FROM DEMOGRAPHIC D 
INNER JOIN COUPON_REDEMPT_NEW C 
ON D.HOUSEHOLD_KEY = C.HOUSEHOLD_KEY
GROUP BY 1 
ORDER BY 2 DESC ;

SELECT * FROM INCOME_COUP ;

CREATE VIEW AGE_COUPON AS 
SELECT D.AGE_DESC , COUNT(DISTINCT C.COUPON_UPC) AS COUPON_REDEEMED FROM DEMOGRAPHIC D 
INNER JOIN COUPON_REDEMPT_NEW C 
ON D.HOUSEHOLD_KEY = C.HOUSEHOLD_KEY
GROUP BY 1 
ORDER BY 2 DESC ;

SELECT * FROM AGE_COUPON ;

SELECT * FROM CAMPAIGN_DESCRIPTION ;
SELECT * FROM TRANSACTION_NEW ;
SELECT * FROM CAMPAIGN_RAW ;
SELECT * FROM DEMOGRAPHIC ;
SELECT * FROM PRODUCT_RAW;

SELECT avg (trans_time)/60  FROM TRANSACTION_NEW ; 

select sum(retail_disc) from transaction_new;

select sum(coupon_disc) from transaction_new;

SELECT ROUND(COUNT(DISTINCT C.COUPON_UPC)/COUNT(DISTINCT CR.COUPON_UPC)*100,2) AS PERCENTAGE_COUP FROM 
COUPON_RAW C LEFT OUTER JOIN  COUPON_REDEMPT_NEW CR ON 
C.COUPON_UPC = CR.COUPON_UPC;

CREATE VIEW PER_COUP_RED AS 
SELECT SUM(COUPON_REDEEMED)/SUM(COUPON_GIVEN)*100 AS PERC_COUP FROM COUPON_REDEMPTION ;

CREATE VIEW HOUSE_SIZE_SALE AS 
SELECT D.HOUSEHOLD_SIZE_DESC , SUM(T.SALES_VALUE) AS TOTAL_SALE FROM DEMOGRAPHIC D 
INNER JOIN TRANSACTION_NEW T 
ON D.HOUSEHOLD_KEY  = T.HOUSEHOLD_KEY 
GROUP BY 1 
ORDER BY 2 DESC;
