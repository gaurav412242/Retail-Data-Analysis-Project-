--CREATING STORAGE INTEGRATION
CREATE OR REPLACE STORAGE INTEGRATION S3_INT 
TYPE = EXTERNAL_STAGE 
STORAGE_PROVIDER = S3
ENABLED = TRUE 
STORAGE_AWS_ROLE_ARN = 'arn:aws:iam::003902404202:role/retailrole7'
STORAGE_ALLOWED_LOCATIONS = ('s3://retailraw7/');

DESC INTEGRATION S3_INT ;

--CREATING FILE_FORMAT  
CREATE OR REPLACE FILE FORMAT CSV
TYPE = 'CSV'
COMPRESSION = 'NONE'
FIELD_DELIMITER = ','
field_optionally_enclosed_by = 'none'
skip_header = 1 ;  

--CREATING STAGE
CREATE OR REPLACE STAGE RETAIL
URL = 's3://retailraw7'
FILE_FORMAT = CSV
STORAGE_INTEGRATION = S3_INT ;

LIST @RETAIL ; 

SHOW STAGES;

--CREATING SNOWPIPE 
CREATE OR REPLACE PIPE RETAIL_SNOWPIPE_DEMOGRAPHIC 
AUTO_INGEST = TRUE AS
COPY INTO RETAIL.PUBLIC.DEMOGRAPHIC
FROM '@RETAIL/DEMOGRAPHIC/'
FILE_FORMAT = CSV;

CREATE OR REPLACE PIPE RETAIL_SNOWPIPE_CAMPAIGN_DESC
AUTO_INGEST = TRUE AS  
COPY INTO RETAIL.PUBLIC.CAMPAIGN_DESC_RAW
FROM '@RETAIL/CAMPAIGN_DESC_RAW/'
FILE_FORMAT = CSV ;

CREATE OR REPLACE PIPE RETAIL_SNOWPIPE_CAMPAIGN
AUTO_INGEST = TRUE AS 
COPY INTO RETAIL.PUBLIC.CAMPAIGN_RAW
FROM '@RETAIL/CAMPAIGN_RAW/'
FILE_FORMAT = CSV ;

CREATE OR REPLACE PIPE RETAIL_SNOWPIPE_COUPON
AUTO_INGEST = TRUE AS 
COPY INTO RETAIL.PUBLIC.COUPON_RAW
FROM '@RETAIL/COUPON_RAW/'
FILE_FORMAT = CSV ;

CREATE OR REPLACE PIPE RETAIL_SNOWPIPE_COUPON_REDEMPT
AUTO_INGEST = TRUE AS 
COPY INTO RETAIL.PUBLIC.COUPON_REDEMPT_RAW
FROM '@RETAIL/COUPON_REDEMPT_RAW/'
FILE_FORMAT = CSV ;

CREATE OR REPLACE PIPE RETAIL_SNOWPIPE_PRODUCT 
AUTO_INGEST = TRUE AS 
COPY INTO RETAIL.PUBLIC.PRODUCT_RAW
FROM '@RETAIL/PRODUCT_RAW/'
FILE_FORMAT = CSV ;

CREATE OR REPLACE PIPE RETAIL_SNOWPIPE_TRANSACTION 
AUTO_INGEST = TRUE AS 
COPY INTO RETAIL.PUBLIC.TRANSACTION_RAW
FROM '@RETAIL/TRANSACTION_RAW/'
FILE_FORMAT = CSV ;


SHOW PIPES;

ALTER PIPE RETAIL_SNOWPIPE_DEMOGRAPHIC REFRESH ;
SELECT * FROM DEMOGRAPHIC ;

ALTER PIPE RETAIL_SNOWPIPE_CAMPAIGN_DESC REFRESH;
SELECT * FROM CAMPAIGN_DESC_RAW ;

ALTER PIPE RETAIL_SNOWPIPE_CAMPAIGN REFRESH ;
SELECT * FROM CAMPAIGN_RAW ;

ALTER PIPE RETAIL_SNOWPIPE_COUPON REFRESH ;
SELECT * FROM COUPON_RAW ;


ALTER PIPE RETAIL_SNOWPIPE_COUPON REFRESH ;
SELECT * FROM COUPON_RAW ;


ALTER PIPE RETAIL_SNOWPIPE_COUPON_REDEMPT REFRESH ;
SELECT * FROM COUPON_REDEMPT_RAW ;

ALTER PIPE RETAIL_SNOWPIPE_PRODUCT REFRESH ;
SELECT * FROM PRODUCT_RAW ;

ALTER PIPE RETAIL_SNOWPIPE_TRANSACTION REFRESH ;
SELECT * FROM TRANSACTION_RAW ;
